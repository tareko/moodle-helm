{{- if .Values.backups.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "moodle.fullname" . }}-backup-files
  labels:
    {{- include "moodle.labels" . | nindent 4 }}
    app.kubernetes.io/component: backup
spec:
  schedule: {{ .Values.backups.moodleFiles.schedule | quote }}
  successfulJobsHistoryLimit: {{ .Values.backups.moodleFiles.successfulJobsHistoryLimit }}
  failedJobsHistoryLimit: {{ .Values.backups.moodleFiles.failedJobsHistoryLimit }}
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            {{- include "moodle.selectorLabels" . | nindent 12 }}
            app.kubernetes.io/component: backup
        spec:
          restartPolicy: OnFailure
          containers:
            - name: files-backup
              image: {{ .Values.backups.moodleFiles.image | quote }}
              command:
                - /bin/sh
                - -ec
                - |
                  TS="$(date +%Y%m%d-%H%M%S)"
                  cat <<EOF > /tmp/backup-manifest-${TS}.json
                  {
                    "timestamp": "${TS}",
                    "moodleSite": "{{ .Values.gateway.hostname }}",
                    "storageDriver": "{{ .Values.storage.filedir.driver }}",
                    "note": "For objectfs-backed filedir, source of truth is Spaces bucket {{ .Values.spaces.bucket }}"
                  }
                  EOF
                  aws s3 cp /tmp/backup-manifest-${TS}.json s3://$BACKUP_BUCKET/moodle-manifests/backup-manifest-${TS}.json --endpoint-url "$SPACES_ENDPOINT"
                  aws s3 sync s3://$PRIMARY_BUCKET s3://$BACKUP_BUCKET/moodle-files-mirror/ --endpoint-url "$SPACES_ENDPOINT" --delete
              env:
                - name: PRIMARY_BUCKET
                  value: {{ .Values.spaces.bucket | quote }}
                - name: BACKUP_BUCKET
                  value: {{ .Values.spaces.backupBucket | quote }}
                - name: SPACES_ENDPOINT
                  value: {{ include "moodle.spacesEndpointUrl" . | quote }}
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.spaces.credentialsSecret.name }}
                      key: {{ .Values.spaces.credentialsSecret.accessKeyKey }}
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.spaces.credentialsSecret.name }}
                      key: {{ .Values.spaces.credentialsSecret.secretKeyKey }}
                - name: AWS_DEFAULT_REGION
                  value: {{ .Values.spaces.region | quote }}
{{- end }}

